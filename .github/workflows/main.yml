name: Build and Upload Python Wheel to GitHub Release

on:
  release:
    types:
      - published

jobs:
  build-and-upload:
    runs-on: ubuntu-latest

    steps:
      # Step 1: Checkout the code
      - name: Checkout Code
        uses: actions/checkout@v3

      # Step 2: Set up Python environment
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      # Step 3: Install required tools
      - name: Install Build Tools
        run: |
          python -m pip install --upgrade pip setuptools wheel

      # Step 4: Fix multiple top-level package issue in setup.py
      - name: Fix Setup.py
        run: |
          echo "
          from setuptools import setup, find_packages

          setup(
              name='ccxt-custom',
              version='0.1.0',
              packages=find_packages(include=['ts*', 'cs*', 'js*', 'php*', 'wiki*']),
              # Adjust metadata as needed
              description='CCXT custom package',
              author='eq19',
              author_email='eq19@users.noreply.github.com',
              url='https://github.com/KernelPatterns/ccxt',
          )
          " > setup.py

      # Step 5: Build the wheel
      - name: Build Wheel
        run: |
          python setup.py sdist bdist_wheel

      # Step 6: Upload the wheel to GitHub Release
      - name: Upload to GitHub Release
        uses: ncipollo/release-action@v1
        with:
          artifacts: dist/*
          token: ${{ secrets.ACCESS_TOKEN }}
